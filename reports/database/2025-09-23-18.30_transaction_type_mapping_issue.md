# Database Transaction Type Mapping Issue Analysis

**Report Date:** September 23, 2025 6:30 PM ET
**Issue:** CUSIP 380037FU0 municipal bond interest loaded as "dividend" instead of "interest"
**Database:** Local Supabase PostgreSQL at localhost:54322

## Executive Summary

Investigation confirmed the user's report: CUSIP 380037FU0 municipal bond interest transactions are incorrectly loaded as "dividend" transaction type instead of "interest". The issue stems from the loader's section-based mapping logic, which maps all transactions from the `dividends_interest_income` section to "dividend" type, regardless of the individual transaction's description.

## Database Query Results

**Found Transactions:**
```sql
SELECT id, sec_cusip, transaction_type, description, amount, transaction_date, security_name
FROM transactions WHERE sec_cusip = '380037FU0';
```

**Results:**
- **2 transactions** found for CUSIP 380037FU0
- **Both loaded as:** `transaction_type = 'dividend'`
- **Description:** "Muni Exempt Int" (clearly indicating municipal exempt interest)
- **Amount:** $1,250.00 each
- **Date:** 2025-08-01
- **Security:** GLYNN-BRUNSWICK MEM HOSP AUTH GA REV REV 05.00000% 08/01/2026

## Root Cause Analysis

### Current Mapping Logic in simple_loader.py

The loader uses section-based mapping defined in `ACTIVITY_SECTIONS` dictionary (lines 49-62):

```python
ACTIVITY_SECTIONS = {
    'dividends_interest_income': 'dividend',  # <-- PROBLEM HERE
    'deposits': 'deposit',
    'withdrawals': 'withdrawal',
    # ... other mappings
}
```

### The Problem

1. **Section-based mapping is too broad:** All transactions from `dividends_interest_income` section get mapped to "dividend" type
2. **Ignores transaction-level context:** The loader doesn't examine the `description` field to distinguish between:
   - Actual dividends from stocks/funds
   - Municipal bond interest (tax-exempt)
   - Corporate bond interest (taxable)
   - Other interest types

### JSON Extraction Data

From `/documents/5loaded/Fid_Stmnt_2025-08_Brok+CMA_activities_2025.09.22_14.30ET.json`:

```json
{
  "settlement_date": "2025-08-01",
  "sec_description": "GLYNN-BRUNSWICK MEM HOSP AUTH GA REV REV 05.00000% 08/01/2026 ANTIC CTFS SOUTHEAST GEORGIA HEALTH SYSTEM INC SOUTHEAST",
  "sec_symbol": null,
  "cusip": "380037FU0",
  "description": "Muni Exempt Int",  # <-- Clear indicator this is interest
  "quantity": null,
  "price_per_unit": null,
  "amount": "1250.00"
}
```

**Key Evidence:**
- `description: "Muni Exempt Int"` - Clearly indicates municipal exempt interest
- `sec_description` contains "05.00000%" - Bond coupon rate indicator
- Located in `dividends_interest_income` section (appropriate section placement)

## Impact Assessment

### Tax Implications
- **Critical Issue:** Municipal bond interest is typically tax-exempt at federal level
- **Incorrect categorization** as dividend could lead to improper tax treatment
- **Georgia municipal bonds** may have state tax implications requiring proper classification

### Data Integrity
- **Transaction count affected:** Potentially all municipal bond interest transactions
- **Other securities potentially affected:** Corporate bonds, CDs, other interest-bearing securities
- **Financial reporting accuracy:** Income categorization will be incorrect

## Recommended Solutions

### Option 1: Enhanced Description-Based Mapping (Recommended)

Modify the `load_activities` function to examine transaction descriptions for refinement:

```python
def determine_transaction_type(section_name, description):
    """Determine transaction type based on section and description"""
    base_type = ACTIVITY_SECTIONS.get(section_name, 'other')

    if base_type == 'dividend' and description:
        desc_lower = description.lower()
        if any(keyword in desc_lower for keyword in ['muni exempt int', 'municipal int', 'bond int', 'interest']):
            return 'interest'

    return base_type
```

### Option 2: Separate Interest Mapping

Add explicit mappings for known interest descriptions:

```python
INTEREST_DESCRIPTIONS = {
    'Muni Exempt Int': 'interest',
    'Municipal Interest': 'interest',
    'Bond Interest': 'interest',
    'CD Interest': 'interest'
}
```

### Option 3: Tax Category Enhancement

Enhance tax categorization to handle municipal vs corporate interest properly.

## Implementation Priority

**High Priority - Immediate Action Required:**

1. **Fix mapping logic** to properly distinguish interest from dividends
2. **Update existing data** - Create correction script for already-loaded transactions
3. **Test thoroughly** with municipal bond samples before processing more statements

## Data Correction Required

**Immediate Correction Needed:**
```sql
UPDATE transactions
SET transaction_type = 'interest'
WHERE sec_cusip = '380037FU0'
  AND description = 'Muni Exempt Int'
  AND transaction_type = 'dividend';
```

**Broader Correction Query (after testing):**
```sql
UPDATE transactions
SET transaction_type = 'interest'
WHERE transaction_type = 'dividend'
  AND (description ILIKE '%muni exempt int%'
       OR description ILIKE '%municipal int%'
       OR description ILIKE '%bond int%');
```

## Next Steps

1. **Implement enhanced mapping logic** in simple_loader.py
2. **Create and test correction script** for existing data
3. **Validate tax categorization** for municipal vs corporate interest
4. **Document transaction type determination rules** for future reference
5. **Test with additional municipal bond samples** to ensure comprehensive coverage

## Files Examined

- `/Users/richkernan/Projects/Finances/simple_loader.py` - Main loader logic
- `/Users/richkernan/Projects/Finances/documents/5loaded/Fid_Stmnt_2025-08_Brok+CMA_activities_2025.09.22_14.30ET.json` - Source extraction
- PostgreSQL transactions table - Current data state

## Performance Impact

- **Query performance:** No impact expected from enhanced mapping logic
- **Loading time:** Minimal increase due to additional description checking
- **Data accuracy:** Significant improvement in transaction categorization

---

**Conclusion:** The section-based mapping approach needs refinement to handle the nuanced differences between dividends and interest income within the same document section. The fix is straightforward but requires both code updates and data correction for already-loaded transactions.